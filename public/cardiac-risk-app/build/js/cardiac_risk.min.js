function initialSetup(){initalizeLogging(),$(window).resize(function(){adjustRelatedFactorsSize();var a=$(".contentBoxLeft");a.width()<490&&a.width()>377&&adjustRangeSliderThumbPosition()})}function initalizeLogging(){Canadarm.init({onError:!1,wrapEvents:!1,logLevel:Canadarm.level.INFO,appenders:[Canadarm.Appender.standardLogAppender],handlers:[Canadarm.Handler.beaconLogHandler(config.canadarm_beacon_url),Canadarm.Handler.consoleLogHandler]})}function updatePatientDemographicsBanner(){$("#patientName").text(CardiacRisk.patientInfo.firstName+" "+CardiacRisk.patientInfo.lastName);var a=" yrs";CardiacRisk.patientInfo.age&&(a=CardiacRisk.patientInfo.age+a),$("#patientAge").text(a),"male"===CardiacRisk.patientInfo.gender?$("#patientGender").text("M"):"female"===CardiacRisk.patientInfo.gender&&$("#patientGender").text("F");var b=CardiacRisk.patientInfo.dateOfBirth,c="";"[object Date]"!==Object.prototype.toString.call(b)||isNaN(b.getTime())||(c=b.getMonth()+"/"+b.getDate()+"/"+b.getFullYear()),$("#patientDOB").text(c)}function updatePatientActions(){var a=CardiacRisk.computePatientActions();$("#contentDietExerciseHeader").text(a.dietHeader),$("#contentDietExercise").text(a.diet),$("#contentDoctorHeader").text(a.doctorHeader),$("#contentDoctor").text(a.doctor),$("#contentRetesting").text(a.retesting)}function checkForIncompleteState(){CardiacRisk.canCalculateCardiacRiskScore()||($("#resultsInfo").removeClass("contentHidden"),$("#resultsSliders").removeClass("contentHidden"),$("#riskBar").removeClass().addClass("riskBarIncomplete"),$("#riskMessage").text("Incomplete"),$("#riskDescriptionText").text("Related factors must be completed in order to calculate your cardiac risk score."),$("#riskDescriptionValue").text(""),$("#containerPatientActions").removeClass().addClass("contentHiddenVisibility"),$("#whatIfContainer").removeClass().addClass("contentHidden"),$("#horizontalRule").removeClass().addClass("contentHidden")),$("#sbpInput").val(CardiacRisk.patientInfo.systolicBloodPressure),onSBPInput()}function validData(){var a=CardiacRisk.validateModelForErrors();return a.length>0?(processError(a),!1):!0}function processError(a){CardiacRisk.shouldProcessError&&(CardiacRisk.shouldProcessError=!1,$("#pageLoading").removeClass().addClass("contentHidden"),$("#pageError").removeClass().addClass("contentErrorLayout"),$("#pageContent").removeClass().addClass("contentHidden"),$("#pageErrorLabel").text(a))}function updateUI(){$("#containerPatientActions").removeClass().addClass("patientActions"),$("#whatIfContainer").removeClass().addClass("whatIfContainerLayout"),$("#horizontalRule").removeClass().addClass("hrStyle"),updateUICardiacRiskScore(),updateUIWhatIfSystolicBloodPressure(),updateUIWhatIfNotSmoker(),updateUIWhatIfOptimalValues(),updateUIWhatIfContainer(),adjustRelatedFactorsSize()}function addEventListeners(){$("#sbpInput").keypress(function(a){return isNumberKey(a)}),$("#sbpInput").on("focusout",sbpInputFocusOutHandler),$('[name="smoker"]').change(onSmokerInput),$('[name="familyHeartAttackHistory"]').change(onFamilyHistoryInput)}function onSBPInput(){var a=document.getElementById("sbpInput").value;CardiacRisk.isValidSysBP(a)?(CardiacRisk.patientInfo.systolicBloodPressure=a,$("#legendSysBPError").removeClass().addClass("relatedFactorsErrorsHidden"),$("#asteriskSBP").removeClass().addClass("contentHidden"),$("#sbpInput").val(a),CardiacRisk.canCalculateCardiacRiskScore()&&updateUI()):void 0!==CardiacRisk.patientInfo.systolicBloodPressure?$("#sbpInput").val(CardiacRisk.patientInfo.systolicBloodPressure):void 0===CardiacRisk.patientInfo.systolicBloodPressure&&($("#legendSysBPError").removeClass().addClass("relatedFactorsErrors"),$("#asteriskSBP").removeClass().addClass("asterisk"))}function onSmokerInput(){void 0===CardiacRisk.patientInfo.relatedFactors.smoker&&($("#legendSmokerError").toggleClass("relatedFactorsErrors relatedFactorsErrorsHidden"),$("#asteriskSmoker").removeClass().addClass("contentHidden")),"yes"===$(this).val()?(CardiacRisk.patientInfo.relatedFactors.smoker=!0,$("#contentSmokingHeader").text("Quit smoking"),$("#contentSmoking").text("By stopping smoking, you can drastically decrease your heart disease risk!")):(CardiacRisk.patientInfo.relatedFactors.smoker=!1,$("#whatIfNotSmoker").addClass("contentHidden"),$("#contentSmokingHeader").text("Stay smoke free"),$("#contentSmoking").text("By not smoking, you are keeping your heart disease risk low!")),CardiacRisk.canCalculateCardiacRiskScore()&&updateUI()}function onFamilyHistoryInput(){void 0===CardiacRisk.patientInfo.relatedFactors.familyHeartAttackHistory&&($("#legendFamilyHistoryError").toggleClass("relatedFactorsErrors relatedFactorsErrorsHidden"),$("#asteriskFamilyHistory").removeClass().addClass("contentHidden")),"yes"===$(this).val()?CardiacRisk.patientInfo.relatedFactors.familyHeartAttackHistory=!0:CardiacRisk.patientInfo.relatedFactors.familyHeartAttackHistory=!1,CardiacRisk.canCalculateCardiacRiskScore()&&updateUI()}function updateUICardiacRiskScore(){var a=CardiacRisk.computeRRS(CardiacRisk.patientInfo);CardiacRisk.currentCardiacRiskScore=a,$("#riskDescriptionText").text("Your chance of having a heart attack, stroke, or other heart disease event at some point in the next 10 years is "),$("#riskDescriptionValue").text(a+"%");var b=$("#riskBar"),c=$("#riskMessage");5>a?(b.removeClass().addClass("riskBarLowRisk"),c.text("Low Risk")):a>=5&&10>a?(b.removeClass().addClass("riskBarLowModerateRisk"),c.text("Low-Moderate Risk")):a>=10&&20>a?(b.removeClass().addClass("riskBarModerateRisk"),c.text("Moderate Risk")):a>=20&&(b.removeClass().addClass("riskBarHighRisk"),c.text("High Risk"))}function updateUIWhatIfSystolicBloodPressure(){var a=CardiacRisk.computeWhatIfSBP();void 0===a||a.score>=CardiacRisk.currentCardiacRiskScore?$("#whatIfSBP").addClass("contentHidden"):($("#whatIfSBP").removeClass("contentHidden"),$("#whatIfSBPValue").text(a.value),$("#whatIfSBPValueText").text(a.valueText))}function updateUIWhatIfNotSmoker(){var a=CardiacRisk.computeWhatIfNotSmoker();if(void 0===a||CardiacRisk.patientInfo.relatedFactors.smoker===!1||a>=CardiacRisk.currentCardiacRiskScore)$("#whatIfNotSmoker").addClass("contentHidden");else{var b=CardiacRisk.buildWhatIfNotSmoker(a);$("#whatIfNotSmoker").removeClass("contentHidden"),$("#whatIfNoSmokerValue").text(b.value)}}function updateUIWhatIfOptimalValues(){var a=CardiacRisk.computeWhatIfOptimal();if(void 0===a||a>=CardiacRisk.currentCardiacRiskScore)$("#whatIfOptimal").addClass("contentHidden");else{var b=CardiacRisk.buildWhatIfOptimalValues(a);$("#whatIfOptimal").removeClass("contentHidden"),$("#whatIfOptimalValue").text(b.value),$("#whatIfOptimalValueText").text(b.valueText)}}function updateUIWhatIfContainer(){$("#whatIfSBP").hasClass("contentHidden")&&$("#whatIfNotSmoker").hasClass("contentHidden")&&$("#whatIfOptimal").hasClass("contentHidden")?$("#whatIfContainer").addClass("contentHidden"):$("#whatIfContainer").removeClass("contentHidden")}function createRangeSliderGraphs(){buildRangeSliderDataModel(),createCRPSlider(),createCholesterolSlider(),createLDLSlider(),createHDLSlider()}function createCRPSlider(){var a="",b="",c="";CardiacRisk.patientInfo.hsCReactiveProtein<1?(a=CardiacRisk.graphData.crpSliderData.toolTipData.keys[0],b=CardiacRisk.colorClasses.lowRisk):CardiacRisk.patientInfo.hsCReactiveProtein>=1&&CardiacRisk.patientInfo.hsCReactiveProtein<=3?(a=CardiacRisk.graphData.crpSliderData.toolTipData.keys[1],b=CardiacRisk.colorClasses.moderateRisk):CardiacRisk.patientInfo.hsCReactiveProtein>3&&(a=CardiacRisk.graphData.crpSliderData.toolTipData.keys[2],b=CardiacRisk.colorClasses.highRisk,c=CardiacRisk.colorClasses.rangeSliderThumbWhiteText),CardiacRisk.graphData.crpSliderData.thumbDisplayText=a,CardiacRisk.graphData.crpSliderData.value=CardiacRisk.patientInfo.hsCReactiveProtein,generateRangeSlider(CardiacRisk.graphData.crpSliderData),changeBarBackgroundColor(CardiacRisk.graphData.crpSliderData.id,CardiacRisk.colorClasses.grayBarColor),changeThumbBackgroundColor(CardiacRisk.graphData.crpSliderData.id,b),changeThumbTextColor(CardiacRisk.graphData.crpSliderData.id,c)}function createCholesterolSlider(){var a="",b="",c="";CardiacRisk.patientInfo.totalCholesterol<200?(a=CardiacRisk.graphData.totalCholesterolSliderData.toolTipData.keys[0],b=CardiacRisk.colorClasses.lowRisk):CardiacRisk.patientInfo.totalCholesterol>=200&&CardiacRisk.patientInfo.totalCholesterol<240?(a=CardiacRisk.graphData.totalCholesterolSliderData.toolTipData.keys[1],b=CardiacRisk.colorClasses.moderateRisk):CardiacRisk.patientInfo.totalCholesterol>=240&&(a=CardiacRisk.graphData.totalCholesterolSliderData.toolTipData.keys[2],b=CardiacRisk.colorClasses.highRisk,c=CardiacRisk.colorClasses.rangeSliderThumbWhiteText),CardiacRisk.graphData.totalCholesterolSliderData.thumbDisplayText=a,CardiacRisk.graphData.totalCholesterolSliderData.value=CardiacRisk.patientInfo.totalCholesterol,generateRangeSlider(CardiacRisk.graphData.totalCholesterolSliderData),changeBarBackgroundColor(CardiacRisk.graphData.totalCholesterolSliderData.id,CardiacRisk.colorClasses.grayBarColor),changeThumbBackgroundColor(CardiacRisk.graphData.totalCholesterolSliderData.id,b),changeThumbTextColor(CardiacRisk.graphData.totalCholesterolSliderData.id,c)}function createLDLSlider(){if(void 0===CardiacRisk.patientInfo.ldl)$("#ldlBadCholesterolSlider").addClass("contentHidden"),$("#rangeSlidersVerticalLine").removeClass().addClass("verticalLineHalf");else{var a="",b="",c="";CardiacRisk.patientInfo.ldl<100?(a=CardiacRisk.graphData.ldlSliderData.toolTipData.keys[0],b=CardiacRisk.colorClasses.lowRisk):CardiacRisk.patientInfo.ldl>=100&&CardiacRisk.patientInfo.ldl<130?(a=CardiacRisk.graphData.ldlSliderData.toolTipData.keys[1],b=CardiacRisk.colorClasses.lowModerateRisk):CardiacRisk.patientInfo.ldl>=130&&CardiacRisk.patientInfo.ldl<160?(a=CardiacRisk.graphData.ldlSliderData.toolTipData.keys[2],b=CardiacRisk.colorClasses.moderateRisk):CardiacRisk.patientInfo.ldl>=160&&CardiacRisk.patientInfo.ldl<190?(a=CardiacRisk.graphData.ldlSliderData.toolTipData.keys[3],b=CardiacRisk.colorClasses.highRisk,c=CardiacRisk.colorClasses.rangeSliderThumbWhiteText):CardiacRisk.patientInfo.ldl>=190&&(a=CardiacRisk.graphData.ldlSliderData.toolTipData.keys[4],b=CardiacRisk.colorClasses.highRisk,c=CardiacRisk.colorClasses.rangeSliderThumbWhiteText),CardiacRisk.graphData.ldlSliderData.thumbDisplayText=a,CardiacRisk.graphData.ldlSliderData.value=CardiacRisk.patientInfo.ldl,generateRangeSlider(CardiacRisk.graphData.ldlSliderData),changeBarBackgroundColor(CardiacRisk.graphData.ldlSliderData.id,CardiacRisk.colorClasses.grayBarColor),changeThumbBackgroundColor(CardiacRisk.graphData.ldlSliderData.id,b),changeThumbTextColor(CardiacRisk.graphData.ldlSliderData.id,c)}}function createHDLSlider(){var a="",b="",c="";CardiacRisk.patientInfo.hdl<40&&"male"===CardiacRisk.patientInfo.gender||CardiacRisk.patientInfo.hdl<50&&"female"===CardiacRisk.patientInfo.gender?(a=CardiacRisk.graphData.hdlSliderData.toolTipData.keys[2],b=CardiacRisk.colorClasses.highRisk,c=CardiacRisk.colorClasses.rangeSliderThumbWhiteText):CardiacRisk.patientInfo.hdl>=40&&CardiacRisk.patientInfo.hdl<60&&"male"===CardiacRisk.patientInfo.gender||CardiacRisk.patientInfo.hdl>=50&&CardiacRisk.patientInfo.hdl<60&&"female"===CardiacRisk.patientInfo.gender?(a=CardiacRisk.graphData.hdlSliderData.toolTipData.keys[1],b=CardiacRisk.colorClasses.moderateRisk):CardiacRisk.patientInfo.hdl>=60&&(a=CardiacRisk.graphData.hdlSliderData.toolTipData.keys[0],b=CardiacRisk.colorClasses.lowRisk),CardiacRisk.graphData.hdlSliderData.thumbDisplayText=a,CardiacRisk.graphData.hdlSliderData.value=CardiacRisk.patientInfo.hdl,generateRangeSlider(CardiacRisk.graphData.hdlSliderData),changeBarBackgroundColor(CardiacRisk.graphData.hdlSliderData.id,CardiacRisk.colorClasses.grayBarColor),changeThumbBackgroundColor(CardiacRisk.graphData.hdlSliderData.id,b),changeThumbTextColor(CardiacRisk.graphData.hdlSliderData.id,c)}function sbpInputFocusOutHandler(){$(this).val().length<3&&$(this).val(CardiacRisk.patientInfo.systolicBloodPressure)}function isNumberKey(a){var b=a.which?a.which:event.keyCode;if(13===b||b>31&&(48>b||b>57))return!1;$sbpInput=$("#sbpInput");var c=$sbpInput.val();return 2===c.length&&($sbpInput.val(c+String.fromCharCode(b)),onSBPInput()),!0}function adjustRelatedFactorsSize(){var a=$("#containerPatientActions").width();$("#containerPatientDetails").width(a);var b=$("#contentBoxRightBottom").width();$("#contentBoxRightTop").width(b)}function adjustRangeSliderThumbPosition(){updateThumbPosition(CardiacRisk.graphData.crpSliderData.id,CardiacRisk.graphData.crpSliderData.value,CardiacRisk.graphData.crpSliderData.lowerBound,CardiacRisk.graphData.crpSliderData.upperBound),updateThumbPosition(CardiacRisk.graphData.totalCholesterolSliderData.id,CardiacRisk.graphData.totalCholesterolSliderData.value,CardiacRisk.graphData.totalCholesterolSliderData.lowerBound,CardiacRisk.graphData.totalCholesterolSliderData.upperBound),updateThumbPosition(CardiacRisk.graphData.ldlSliderData.id,CardiacRisk.graphData.ldlSliderData.value,CardiacRisk.graphData.ldlSliderData.lowerBound,CardiacRisk.graphData.ldlSliderData.upperBound),updateThumbPosition(CardiacRisk.graphData.hdlSliderData.id,CardiacRisk.graphData.hdlSliderData.value,CardiacRisk.graphData.hdlSliderData.lowerBound,CardiacRisk.graphData.hdlSliderData.upperBound)}function buildRangeSliderDataModel(){var a={},b={};b.id="cReactiveProteinSlider",b.titleLeft="C Reactive Protein",b.titleRight="mg/L",b.lowerBound=.03,b.upperBound=20,b.barBoundsLowDisplay="Low",b.barBoundsHighDisplay="High",b.toolTipData={keys:["Low","Moderate","High"],values:["0.03 - 0.9","1 - 2.9","3 - 20"],styleClass:"tooltipsterCardiacRiskCRP"},a.crpSliderData=b;var c={};if(c.id="totalCholesterolSlider",c.titleLeft="Total Cholesterol",c.titleRight="mg/dL",c.lowerBound=140,c.upperBound=401,c.barBoundsLowDisplay="Desirable",c.barBoundsHighDisplay="High",c.toolTipData={keys:["Desirable","Borderline High","High"],values:["140 - 199","200 - 239","240 - 401"],styleClass:"tooltipsterCardiacRiskTotalCholesterol"},a.totalCholesterolSliderData=c,void 0!==CardiacRisk.patientInfo.ldl){var d={};d.id="ldlBadCholesterolSlider",d.titleLeft='LDL "Bad" Cholesterol',d.titleRight="mg/dL",d.lowerBound=50,d.upperBound=210,d.barBoundsLowDisplay="Optimal",d.barBoundsHighDisplay="High",d.toolTipData={keys:["Optimal","Near/Above Optimal","Borderline High","High","Very High"],values:["50 - 100","101 - 129","130 - 159","160 - 189","190 - 210"],styleClass:"tooltipsterCardiacRiskLDL"},d.barHeight=6,a.ldlSliderData=d}var e={};e.id="hdlGoodCholesterolSlider",e.titleLeft='HDL "Good" Cholesterol',e.titleRight="mg/dL",e.lowerBound=30,e.upperBound=150,e.barBoundsLowDisplay="Protective",e.barBoundsHighDisplay="High","male"===CardiacRisk.patientInfo.gender?e.toolTipData={keys:["High","Higher the Better","Low"],values:["60 - 150","40 - 59","30 - 39"],styleClass:"tooltipsterCardiacRiskHDL"}:"female"===CardiacRisk.patientInfo.gender&&(e.toolTipData={keys:["High","Higher the Better","Low"],values:["60 - 150","50 - 59","30 - 49"],styleClass:"tooltipsterCardiacRiskHDL"}),e.barHeight=6,a.hdlSliderData=e,CardiacRisk.graphData=a}function generateRangeSlider(a){var b=$("#"+a.id);b.append("<header id="+a.id+'Header class="rangeSliderHeaderStyle"><div><span id='+a.id+'TitleLeft class="headerLeftStyle">'+a.titleLeft+"</span><span id="+a.id+'Image class="iconStyle fa fa-info-circle"></span>   </div><span id='+a.id+"TitleRight>"+a.titleRight+'</span></header><div class="rangeSliderContentStyle"><div id='+a.id+'Bar class="rangeSliderBarStyle"></div><div id='+a.id+'Thumb class="rangeSliderThumbStyle">'+a.value+"</div><div id="+a.id+'ThumbDisplayText class="rangeSliderThumbDisplayTextStyle">'+a.thumbDisplayText+"</div></div><footer id="+a.id+'Footer class="rangeSliderFooterStyle"><div class="footerLeftStyle"><span id='+a.id+"FooterLeft>"+a.barBoundsLowDisplay+'</span></div><div class="footerRightStyle"><span id='+a.id+"FooterRight>"+a.barBoundsHighDisplay+"</span></div></footer>"),updateBarHeight(a.id,a.barHeight),updateToolTips(a.id,a.toolTipData),updateThumbPosition(a.id,a.value,a.lowerBound,a.upperBound)}function updateToolTips(a,b){var c='<table class="'+b.styleClass+'">',d="";for(step=0;step<b.keys.length;step++)d=d.concat("<tr>"),d=d.concat('<td class="zeroMargin">'+b.keys[step]+'</td><td> </td><td class="zeroMargin">'+b.values[step]+"</td>"),d=d.concat("</tr>");c=c.concat(d,"</table>"),$("#"+a+"Image").tooltipster({contentAsHTML:!0,delay:100,theme:"tooltipster-CardiacRisk",content:$(c)})}function updateBarHeight(a,b){$("#"+a+"Bar").css("height",""),$("#"+a+"Bar").css("height",b),12>b&&($("#"+a+"Header").css("margin-bottom",2*b),$("#"+a+"Thumb").addClass("barHeightThumbAdjustment"),$("#"+a+"ThumbDisplayText").addClass("barHeightThumbTextAdjustment"),$("#"+a+"Footer").addClass("barFooterAdjustment"))}function changeBarBackgroundColor(a,b){$("#"+a+"Bar").css("background-color",""),$("#"+a+"Bar").addClass(b)}function changeThumbBackgroundColor(a,b){$("#"+a+"Thumb").css("background-color",""),$("#"+a+"Thumb").addClass(b)}function changeThumbTextColor(a,b){b.length&&$("#"+a+"Thumb").removeClass("rangeSliderThumbStyle").addClass(b)}function updateThumbPosition(a,b,c,d){var e=0;if(c>=b)return e=0,changeThumbPositionToPosition(a,e),void changeThumbValueTextToPosition(a,e);var f=$("#"+a+"Bar").width(),g=$("#"+a+"Thumb"),h=g.width()+parseFloat(g.css("padding-left").replace(/[^-\d.]/g,""))+parseFloat(g.css("padding-right").replace(/[^-\d.]/g,""))+parseFloat(g.css("borderLeftWidth").replace(/[^-\d.]/g,""))+parseFloat(g.css("borderRightWidth").replace(/[^-\d.]/g,"")),i=b;b>d&&(i=d);var j=(i-c)/(d-c)*f;e=j-h,0>e&&(e=0),changeThumbPositionToPosition(a,e),changeThumbValueTextToPosition(a,e)}function changeThumbValueTextToPosition(a,b){var c=$("#"+a+"Thumb"),d=$("#"+a+"Bar").width(),e=$("#"+a+"ThumbDisplayText").width(),f=c.width()+parseFloat(c.css("padding-left").replace(/[^-\d.]/g,""))+parseFloat(c.css("padding-right").replace(/[^-\d.]/g,""))+parseFloat(c.css("borderLeftWidth").replace(/[^-\d.]/g,""))+parseFloat(c.css("borderRightWidth").replace(/[^-\d.]/g,"")),g=b+f/2-e/2;0>g&&(g=0),g>d-e&&(g=d-e),$("#"+a+"ThumbDisplayText").css("left",""),$("#"+a+"ThumbDisplayText").css("left",g),g>=0&&g<=$("#"+a+"FooterLeft").width()?$("#"+a+"FooterLeft").css("visibility","hidden"):d>=g+e&&g+e>=d-$("#"+a+"FooterRight").width()&&$("#"+a+"FooterRight").css("visibility","hidden")}function changeThumbPositionToPosition(a,b){$("#"+a+"Thumb").css("left",""),$("#"+a+"Thumb").css("left",b)}!function(a,b){"use strict";var c={},d={};c.colorClasses={lowRisk:"backgroundColorLowRisk",lowModerateRisk:"backgroundColorLowModerateRisk",moderateRisk:"backgroundColorModerateRisk",highRisk:"backgroundColorHighRisk",rangeSliderThumbWhiteText:"rangeSliderThumbStyleWhite",grayBarColor:"colorGray"};var e=function(){function a(a){c.hideDemographicsBanner=a.tokenResponse.need_patient_banner===!1;var e=new Date,g=new Date;g.setFullYear(e.getFullYear()-1);var h=a.context.patient.read();h.fail(function(){processError("There was an error loading the application."),Canadarm.error("Patient resource failure while loading cardiac risk app.")}),h.done(function(){var e=a.context.patient.Observation.where.codeIn("http://loinc.org|2089-1","http://loinc.org|13457-7","http://loinc.org|30522-7","http://loinc.org|14647-2","http://loinc.org|2093-3","http://loinc.org|2085-9","http://loinc.org|8480-6","http://loinc.org|8462-4","http://loinc.org|55284-4").date(">="+g.toJSON()).search();$.when(h,e).done(function(e,g){d.firstName=e.name[0].given.join(" "),d.lastName=e.name[0].family.join(" "),d.gender=e.gender,d.dateOfBirth=new Date(e.birthDate),d.age=c.computeAgeFromBirthDate(d.dateOfBirth),c.patientInfo=d;var h={};h.smoker=b,h.familyHeartAttackHistory=b,c.patientInfo.relatedFactors=h,c.processLabsData(f,a,g,function(a){if(c.isRequiredLabsNotAvailable()){var d="";if(c.hasObservationWithUnsupportedUnits)processError("One or more results has an unsupported unit of measure. Cardiac Risk cannot be calculated."),c.unsupportedUnitDataPoint.hasOwnProperty("code")&&(d=c.unsupportedUnitDataPoint.code.text),Canadarm.error("Unsupported unit of measure, observation :",b,{status:c.unsupportedUnitDataPoint.status,value:c.unsupportedUnitDataPoint.valueQuantity.value,unit:c.unsupportedUnitDataPoint.valueQuantity.units,valueString:c.unsupportedUnitDataPoint.valueString,codeText:d});else if(c.unsupportedObservationStructureDataPoint){var e="",f="";c.unsupportedObservationStructureDataPoint.hasOwnProperty("code")&&(d=c.unsupportedObservationStructureDataPoint.code.text),c.unsupportedObservationStructureDataPoint.hasOwnProperty("valueQuantity")&&(e=c.unsupportedObservationStructureDataPoint.valueQuantity.value,f=c.unsupportedObservationStructureDataPoint.valueQuantity.units),Canadarm.error("Unsupported observation structure, observation :",b,{status:c.unsupportedObservationStructureDataPoint.status,value:e,unit:f,valueString:c.unsupportedObservationStructureDataPoint.valueString,codeText:d})}}a.resolve()})}).fail(function(){processError("There was an error loading the application."),Canadarm.error("Observations resource failed.")})})}function e(){processError("There was an error loading the application."),Canadarm.error("Authorization error while loading cardiac risk app."),f.reject()}c.shouldProcessError=!0;var f=$.Deferred();return FHIR.oauth2.ready(a,e),f.promise()};c.fetchDataAndPopulateCardiacRiskObject=e;var f=function(a,b,d,e){c.hasObservationWithUnsupportedUnits=!1;var f={deferred:a,smart:b,nextPageObj:d[1],callBackFunction:e};c.processLabResultsPageData(f,d[0],function(a){a.callBackFunction(a.deferred)})};c.processLabsData=f;var g=function(a,d,e){var f=a.smart.byCodes(d,"code");c.patientInfo.hsCReactiveProtein===b&&(c.patientInfo.hsCReactiveProtein=c.getHSCRPValue(f("30522-7"))),c.patientInfo.totalCholesterol===b&&(c.patientInfo.totalCholesterol=c.getCholesterolValue(f("14647-2","2093-3"))),c.patientInfo.hdl===b&&(c.patientInfo.hdl=c.getCholesterolValue(f("2085-9"))),c.patientInfo.ldlDirect===b&&(c.patientInfo.ldlDirect=c.getCholesterolValue(f("2089-1"))),c.patientInfo.ldlCalculated===b&&(c.patientInfo.ldlCalculated=c.getCholesterolValue(f("13457-7"))),c.patientInfo.systolicBloodPressure===b&&(c.patientInfo.systolicBloodPressure=c.getSystolicBloodPressureValue(f("55284-4"))),c.patientInfo.ldl===b&&(c.patientInfo.ldl=c.patientInfo.ldlDirect),"function"==typeof a.nextPageObj.hasNext&&(c.isLabsNotAvailable()&&a.nextPageObj.hasNext()?c.getLabsNextPage(a,e,function(a,b,d){c.processLabResultsPageData(a,b,d)}):(c.patientInfo.ldl===b&&(c.patientInfo.ldl=c.patientInfo.ldlCalculated),e(a)))};c.processLabResultsPageData=g;var h=function(a,b,c){a.nextPageObj.next().done(function(d){c(a,d,b)}).fail(function(){processError("There was an error loading the application."),Canadarm.error("Failed to fetch additional observations resource pages.")})};c.getLabsNextPage=h;var i=function(a){return a.sort(function(a,b){return Date.parse(b.appliesDateTime)-Date.parse(a.appliesDateTime)}),a};c.sortObservationsByAppliesTimeStamp=i;var j=function(a){return c.getFirstValidDataPointValueFromObservations(a,function(a){return"mg/dL"===a.valueQuantity.units?parseFloat(a.valueQuantity.value):"mmol/L"===a.valueQuantity.units?parseFloat(a.valueQuantity.value)/.026:b})};c.getCholesterolValue=j;var k=function(a){return c.getFirstValidDataPointValueFromObservations(a,function(a){return"mg/L"===a.valueQuantity.units?parseFloat(a.valueQuantity.value):"mmol/L"===a.valueQuantity.units?parseFloat(a.valueQuantity.value)/.1:b})};c.getHSCRPValue=k;var l=function(a){var d=[];return a.forEach(function(a){var b=a.contained.find(function(a){return a.code.coding.find(function(a){return"8480-6"===a.code})});b&&d.push(b)}),c.getFirstValidDataPointValueFromObservations(d,function(a){return"mm[Hg]"===a.valueQuantity.code||"mmHg"===a.valueQuantity.units?parseFloat(a.valueQuantity.value):b})};c.getSystolicBloodPressureValue=l;var m=function(a,d){for(var e=c.sortObservationsByAppliesTimeStamp(a),f=0;f<e.length;f++)if(("final"===e[f].status||"amended"===e[f].status)&&e[f].hasOwnProperty("valueQuantity")&&e[f].valueQuantity.value&&e[f].valueQuantity.units){var g=d(e[f]);if(g!==b)return g;c.hasObservationWithUnsupportedUnits=!0,c.unsupportedUnitDataPoint=e[f]}else c.unsupportedObservationStructureDataPoint=e[f];return b};c.getFirstValidDataPointValueFromObservations=m;var n=function(a){function c(a){return 1==new Date(a,1,29).getMonth()}if("[object Date]"!==Object.prototype.toString.call(a)||isNaN(a.getTime()))return b;var d=new Date,e=d.getFullYear()-a.getFullYear();a.setFullYear(a.getFullYear()+e),a>d&&(e--,a.setFullYear(a.getFullYear()-1));var f=(d.getTime()-a.getTime())/864e5;return Math.floor(e+f/(c(d.getFullYear())?366:365))};c.computeAgeFromBirthDate=n;var o=function(a){function b(a,b){var c=a.age*("female"===b.gender.toLowerCase()?b.age:Math.log(b.age)),d=a.sbp*Math.log(b.systolicBloodPressure),e=a.hsCRP*Math.log(b.hsCReactiveProtein),f=a.cholesterol*Math.log(b.totalCholesterol),g=a.HDL*Math.log(b.hdl),h=a.smoker*(b.relatedFactors.smoker?1:0),i=a.fx_of_mi*(b.relatedFactors.familyHeartAttackHistory?1:0);return c+d+e+f+g+h+i}function c(a,c){var d="female"===c.gender.toLowerCase()?[22.325,.98634]:[33.097,.899],e=b(a,c),f=100*(1-Math.pow(d[1],Math.exp(e-d[0])));return f}var d={};"female"===a.gender.toLowerCase()?d={age:.0799,sbp:3.137,hsCRP:.18,cholesterol:1.382,HDL:-1.172,smoker:.818,fx_of_mi:.438}:"male"===a.gender.toLowerCase()&&(d={age:4.385,sbp:2.607,hsCRP:.102,cholesterol:.963,HDL:-.772,smoker:.405,fx_of_mi:.541});var e=c(d,a);return Math.round(10>e?e.toPrecision(1):e.toPrecision(2))};c.computeRRS=o;var p=function(){var a={},d=$.extend(!0,{},c.patientInfo);if(d.systolicBloodPressure>=129)d.systolicBloodPressure=d.systolicBloodPressure-10;else if(d.systolicBloodPressure>=120&&d.systolicBloodPressure<129)d.systolicBloodPressure=119;else if(d.systolicBloodPressure>=105&&d.systolicBloodPressure<120)return b;var e=c.computeRRS(d);return a.score=e,a.value=e+"%",a.valueText=d.systolicBloodPressure+" mm/Hg",a};c.computeWhatIfSBP=p;var q=function(){var a=$.extend(!0,{},c.patientInfo);return a.relatedFactors.smoker=!1,c.computeRRS(a)};c.computeWhatIfNotSmoker=q;var r=function(){var a=$.extend(!0,{},c.patientInfo);return a.hsCReactiveProtein=.5,a.totalCholesterol=160,a.hdl=60,a.ldl=100,a.systolicBloodPressure=119,a.relatedFactors.smoker=!1,a.relatedFactors.familyHeartAttackHistory=!1,c.computeRRS(a)};c.computeWhatIfOptimal=r;var s=function(){var a={};return c.patientInfo.totalCholesterol<=160&&c.patientInfo.ldl<100&&c.patientInfo.hdl>=60?(a.dietHeader="Continue to eat a healthy diet and exercise",a.diet="A healthy diet and regular exercise can keep cholesterol levels optimal.",a.doctorHeader="Talk to your doctor",a.doctor="Discuss the need to follow up with your primary care provider to monitor your health",c.patientInfo.hsCReactiveProtein<=.5&&(a.retesting="Periodically retest your levels to continually monitor your health.")):(c.patientInfo.totalCholesterol>=160||c.patientInfo.ldl>=130||c.patientInfo.hdl<=60)&&(a.dietHeader="Improve your diet and exercise more",a.diet="A better diet and regular exercise can drastically improve your cholesterol levels.",a.doctorHeader="Talk to your doctor",a.doctor="Discuss statins or other medications with your primary care provider that can help lower cholesterol.",c.patientInfo.hsCReactiveProtein>=.5&&(a.retesting="Retesting in 1 to 2 weeks can help exclude temporary spikes in your blood levels.")),a};c.computePatientActions=s;var t=function(){var a="";return isNaN(c.patientInfo.hsCReactiveProtein)||0===c.patientInfo.hsCReactiveProtein.length||c.patientInfo.hsCReactiveProtein===b?a="Cardiac Risk cannot be calculated without a valid value for High sensitivity C-Reactive Protein.":isNaN(c.patientInfo.totalCholesterol)||0===c.patientInfo.totalCholesterol.length||c.patientInfo.totalCholesterol===b?a="Cardiac Risk cannot be calculated without a valid value for Total Cholesterol.":(isNaN(c.patientInfo.hdl)||0===c.patientInfo.hdl.length||c.patientInfo.hdl===b)&&(a="Cardiac Risk cannot be calculated without a valid value for HDL."),a};d.validateLabsForMissingValueErrors=t;var u=function(){var a="";return c.patientInfo.hsCReactiveProtein<.03?a="C-Reactive Protein levels are too low to return a cardiac risk score.":c.patientInfo.hsCReactiveProtein>20?a="C-Reactive Protein levels are too high to return a cardiac risk score.":c.patientInfo.totalCholesterol<140?a="Total Cholesterol levels are too low to return a cardiac risk score.":c.patientInfo.totalCholesterol>401?a="Total Cholesterol levels are too high to return a cardiac risk score.":c.patientInfo.hdl<30?a="HDL levels are too low to return a cardiac risk score.":c.patientInfo.hdl>150&&(a="HDL levels are too high to return a cardiac risk score."),a};d.validateLabsForOutOfBoundsValueErrors=u;var v=function(a){var b={};return b.value=a+"%",c.patientInfo.relatedFactors.smoker!==!0||c.optimalLabs()?c.patientInfo.relatedFactors.smoker!==!1||c.optimalLabs()?c.patientInfo.relatedFactors.smoker===!0&&c.optimalLabs()?(b.value="",b.valueText=""):c.patientInfo.relatedFactors.smoker===!1&&c.optimalLabs()&&c.patientInfo.relatedFactors.familyHeartAttackHistory===!0&&a>=5?(b.value="",b.valueText="Your risk is the lowest it can be based on the supplied information"):c.patientInfo.relatedFactors.smoker===!1&&c.optimalLabs()&&(b.value="",b.valueText="All levels are currently optimal"):b.valueText=" if all levels were optimal":b.valueText=" if you quit smoking and all levels were optimal",b};c.buildWhatIfOptimalValues=v;var w=function(a){var b={};return b.value=a+"%",b};c.buildWhatIfNotSmoker=w;var x=function(){return c.isValidSysBP(c.patientInfo.systolicBloodPressure)&&c.patientInfo.relatedFactors.smoker!==b&&c.patientInfo.relatedFactors.familyHeartAttackHistory!==b?!0:!1};c.canCalculateCardiacRiskScore=x;var y=function(){return c.patientInfo.hsCReactiveProtein===b||c.patientInfo.totalCholesterol===b||c.patientInfo.hdl===b||c.patientInfo.ldl===b||c.patientInfo.systolicBloodPressure===b?!0:!1};c.isLabsNotAvailable=y;var z=function(){return c.patientInfo.hsCReactiveProtein===b||c.patientInfo.totalCholesterol===b||c.patientInfo.hdl===b?!0:!1};c.isRequiredLabsNotAvailable=z;var A=function(a){return!isNaN(a)&&a!==b&&a>=105&&200>=a?!0:!1};c.isValidSysBP=A;var B=function(){var a=!1;return c.patientInfo.hsCReactiveProtein>=.03&&c.patientInfo.hsCReactiveProtein<=.9&&c.patientInfo.totalCholesterol>=140&&c.patientInfo.totalCholesterol<=199&&c.patientInfo.hdl>=60&&c.patientInfo.hdl<=150&&c.patientInfo.ldl>=50&&c.patientInfo.ldl<=100&&(a=!0),a};c.optimalLabs=B;var C=function(){var a="";return c.patientInfo.age===b||c.patientInfo.age<45||c.patientInfo.age>80?a="Cardiac risk can only be calculated for patients aged 45-80 years old.":(c.patientInfo.gender===b||"male"!==c.patientInfo.gender.toLowerCase()&&"female"!==c.patientInfo.gender.toLowerCase())&&(a="Cardiac Risk Score cannot be calculated for indeterminate gender."),0===a.length&&(a=c.patientInfo.validateLabsForMissingValueErrors()),0===a.length&&(a=c.patientInfo.validateLabsForOutOfBoundsValueErrors()),a};c.validateModelForErrors=C,a.CardiacRisk=c,a.CardiacRisk.patientInfo=d,c._window=a}(this),CardiacRisk.fetchDataAndPopulateCardiacRiskObject().then(function(){CardiacRisk.hideDemographicsBanner?$("#patientDemographics").addClass("contentHidden"):($("#patientDemographics").removeClass("contentHidden"),updatePatientDemographicsBanner()),validData()&&($("#pageLoading").removeClass().addClass("contentHidden"),$("#pageContent").removeClass().addClass("contentLayout"),updatePatientActions(),checkForIncompleteState(),createRangeSliderGraphs(),addEventListeners(),adjustRelatedFactorsSize())}),Array.prototype.find||(Array.prototype.find=function(a){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof a)throw new TypeError("predicate must be a function");
for(var b,c=Object(this),d=c.length>>>0,e=arguments[1],f=0;d>f;f++)if(b=c[f],a.call(e,b,f,c))return b;return void 0});